\begin{center}Copyright \copyright 2012 by William Greiman \end{center} \hypertarget{index_Intro}{}\section{Introduction}\label{index_Intro}
The Arduino Sd\-Fat Library is a minimal implementation of F\-A\-T16 and F\-A\-T32 file systems on S\-D flash memory cards. Standard S\-D and high capacity S\-D\-H\-C cards are supported.

Experimental support for F\-A\-T12 can be enabled by setting F\-A\-T12\-\_\-\-S\-U\-P\-P\-O\-R\-T nonzero in \hyperlink{_sd_fat_config_8h}{Sd\-Fat\-Config.\-h}.

The Sd\-Fat library only supports short 8.\-3 names.

The main classes in Sd\-Fat are \hyperlink{class_sd_fat}{Sd\-Fat}, \hyperlink{class_sd_file}{Sd\-File}, \hyperlink{classfstream}{fstream}, \hyperlink{classifstream}{ifstream}, and \hyperlink{classofstream}{ofstream}.

The \hyperlink{class_sd_fat}{Sd\-Fat} class maintains a volume working directories, a current working directory, and simplifies initialization of other classes.

The \hyperlink{class_sd_file}{Sd\-File} class provides binary file access functions such as open(), read(), remove(), write(), close() and sync(). This class supports access to the root directory and subdirectories.

The \hyperlink{classfstream}{fstream} class implements C++ iostreams for both reading and writing text files.

The \hyperlink{classifstream}{ifstream} class implements the C++ iostreams for reading text files.

The \hyperlink{classofstream}{ofstream} class implements the C++ iostreams for writing text files.

The classes \hyperlink{classibufstream}{ibufstream} and \hyperlink{classobufstream}{obufstream} format and parse character strings in memory buffers.

the classes \hyperlink{class_arduino_in_stream}{Arduino\-In\-Stream} and \hyperlink{class_arduino_out_stream}{Arduino\-Out\-Stream} provide iostream functions for Serial, Liquid\-Crystal, and other devices.

The \hyperlink{class_sd_volume}{Sd\-Volume} class supports F\-A\-T16 and F\-A\-T32 partitions. Most applications will not need to call \hyperlink{class_sd_volume}{Sd\-Volume} member function.

The \hyperlink{class_sd2_card}{Sd2\-Card} class supports access to standard S\-D cards and S\-D\-H\-C cards. Most applications will not need to call \hyperlink{class_sd2_card}{Sd2\-Card} functions. The \hyperlink{class_sd2_card}{Sd2\-Card} class can be used for raw access to the S\-D card.

A number of example are provided in the Sd\-Fat/examples folder. These were developed to test Sd\-Fat and illustrate its use.

Sd\-Fat was developed for high speed data recording. Sd\-Fat was used to implement an audio record/play class, Wave\-R\-P, for the Adafruit Wave Shield. This application uses special \hyperlink{class_sd2_card}{Sd2\-Card} calls to write to contiguous files in raw mode. These functions reduce write latency so that audio can be recorded with the small amount of R\-A\-M in the Arduino.\hypertarget{index_SDcard}{}\section{S\-D\textbackslash{}\-S\-D\-H\-C Cards}\label{index_SDcard}
Arduinos access S\-D cards using the cards S\-P\-I protocol. P\-Cs, Macs, and most consumer devices use the 4-\/bit parallel S\-D protocol. A card that functions well on A P\-C or Mac may not work well on the Arduino.

Most cards have good S\-P\-I read performance but cards vary widely in S\-P\-I write performance. Write performance is limited by how efficiently the card manages internal erase/remapping operations. The Arduino cannot optimize writes to reduce erase operations because of its limit R\-A\-M.

San\-Disk cards generally have good write performance. They seem to have more internal R\-A\-M buffering than other cards and therefore can limit the number of flash erase operations that the Arduino forces due to its limited R\-A\-M.\hypertarget{index_Hardware}{}\section{Hardware Configuration}\label{index_Hardware}
Sd\-Fat was developed using an \href{http://www.adafruit.com/}{\tt Adafruit Industries} \href{http://www.ladyada.net/make/waveshield/}{\tt Wave Shield}.

The hardware interface to the S\-D card should not use a resistor based level shifter. Sd\-Fat sets the S\-P\-I bus frequency to 8 M\-Hz which results in signal rise times that are too slow for the edge detectors in many newer S\-D card controllers when resistor voltage dividers are used.

The 5 to 3.\-3 V level shifter for 5 V Arduinos should be I\-C based like the 74\-H\-C4050\-N based circuit shown in the file Sd\-Level.\-png. The Adafruit Wave Shield uses a 74\-A\-H\-C125\-N. Gravitech sells S\-D and Micro\-S\-D Card Adapters based on the 74\-L\-C\-X245.

If you are using a resistor based level shifter and are having problems try setting the S\-P\-I bus frequency to 4 M\-Hz. This can be done by using card.\-init(\-S\-P\-I\-\_\-\-H\-A\-L\-F\-\_\-\-S\-P\-E\-E\-D) to initialize the S\-D card.\hypertarget{index_comment}{}\section{Bugs and Comments}\label{index_comment}
If you wish to report bugs or have comments, send email to \href{mailto:fat16lib@sbcglobal.net}{\tt fat16lib@sbcglobal.\-net}.\hypertarget{index_SdFatClass}{}\section{Sd\-Fat Usage}\label{index_SdFatClass}
Sd\-Fat uses a slightly restricted form of short names. Only printable A\-S\-C\-I\-I characters are supported. No characters with code point values greater than 127 are allowed. Space is not allowed even though space was allowed in the A\-P\-I of early versions of D\-O\-S.

Short names are limited to 8 characters followed by an optional period (.) and extension of up to 3 characters. The characters may be any combination of letters and digits. The following special characters are also allowed\-:

\$ \% ' -\/ \-\_\- @ $\sim$ ` ! ( ) \{ \} $^\wedge$ \# \&

Short names are always converted to upper case and their original case value is lost.

\begin{DoxyNote}{Note}
The Arduino \hyperlink{class_print}{Print} class uses character at a time writes so it was necessary to use a \hyperlink{class_sd_base_file_a3eb7f41182c04388c951db242c13f845}{sync() } function to control when data is written to the S\-D card.
\end{DoxyNote}
\begin{DoxyParagraph}{}
An application which writes to a file using print(), println() or \hyperlink{class_sd_file_ac82b138293686567ab5dfbe3ba1fa1ee}{write() } must call \hyperlink{class_sd_base_file_a3eb7f41182c04388c951db242c13f845}{sync() } at the appropriate time to force data and directory information to be written to the S\-D Card. Data and directory information are also written to the S\-D card when \hyperlink{class_sd_base_file_a46143fd6de3be9ab9951f140d3ae8c2f}{close() } is called.
\end{DoxyParagraph}
\begin{DoxyParagraph}{}
Applications must use care calling \hyperlink{class_sd_base_file_a3eb7f41182c04388c951db242c13f845}{sync() } since 2048 bytes of I/\-O is required to update file and directory information. This includes writing the current data block, reading the block that contains the directory entry for update, writing the directory block back and reading back the current data block.
\end{DoxyParagraph}
It is possible to open a file with two or more instances of \hyperlink{class_sd_file}{Sd\-File}. A file may be corrupted if data is written to the file by more than one instance of \hyperlink{class_sd_file}{Sd\-File}.\hypertarget{index_HowTo}{}\section{How to format S\-D Cards as F\-A\-T Volumes}\label{index_HowTo}
You should use a freshly formatted S\-D card for best performance. F\-A\-T file systems become slower if many files have been created and deleted. This is because the directory entry for a deleted file is marked as deleted, but is not deleted. When a new file is created, these entries must be scanned before creating the file, a flaw in the F\-A\-T design. Also files can become fragmented which causes reads and writes to be slower.

A formatter sketch, Sd\-Formatter.\-pde, is included in the Sd\-Fat/examples/\-Sd\-Formatter directory. This sketch attempts to emulate S\-D Association's S\-D\-Formatter.

The best way to restore an S\-D card's format on a P\-C is to use S\-D\-Formatter which can be downloaded from\-:

\href{http://www.sdcard.org/consumers/formatter/}{\tt http\-://www.\-sdcard.\-org/consumers/formatter/}

S\-D\-Formatter aligns flash erase boundaries with file system structures which reduces write latency and file system overhead.

S\-D\-Formatter does not have an option for F\-A\-T type so it may format small cards as F\-A\-T12.

After the M\-B\-R is restored by S\-D\-Formatter you may need to reformat small cards that have been formatted F\-A\-T12 to force the volume type to be F\-A\-T16.

If you reformat the S\-D card with an O\-S utility, choose a cluster size that will result in\-:

4084 $<$ Count\-Of\-Clusters \&\& Count\-Of\-Clusters $<$ 65525

The volume will then be F\-A\-T16.

If you are formatting an S\-D card on O\-S X or Linux, be sure to use the first partition. Format this partition with a cluster count in above range for F\-A\-T16. S\-D\-H\-C cards should be formatted F\-A\-T32 with a cluster size of 32 K\-B.

Microsoft operating systems support removable media formatted with a Master Boot Record, M\-B\-R, or formatted as a super floppy with a F\-A\-T Boot Sector in block zero.

Microsoft operating systems expect M\-B\-R formatted removable media to have only one partition. The first partition should be used.

Microsoft operating systems do not support partitioning S\-D flash cards. If you erase an S\-D card with a program like Kill\-Disk, Most versions of Windows will format the card as a super floppy.\hypertarget{index_References}{}\section{References}\label{index_References}
Adafruit Industries\-:

\href{http://www.adafruit.com/}{\tt http\-://www.\-adafruit.\-com/}

\href{http://www.ladyada.net/make/waveshield/}{\tt http\-://www.\-ladyada.\-net/make/waveshield/}

The Arduino site\-:

\href{http://www.arduino.cc/}{\tt http\-://www.\-arduino.\-cc/}

For more information about F\-A\-T file systems see\-:

\href{http://www.microsoft.com/whdc/system/platform/firmware/fatgen.mspx}{\tt http\-://www.\-microsoft.\-com/whdc/system/platform/firmware/fatgen.\-mspx}

For information about using S\-D cards as S\-P\-I devices see\-:

\href{http://www.sdcard.org/developers/tech/sdcard/pls/Simplified_Physical_Layer_Spec.pdf}{\tt http\-://www.\-sdcard.\-org/developers/tech/sdcard/pls/\-Simplified\-\_\-\-Physical\-\_\-\-Layer\-\_\-\-Spec.\-pdf}

The A\-Tmega328 datasheet\-:

\href{http://www.atmel.com/dyn/resources/prod_documents/doc8161.pdf}{\tt http\-://www.\-atmel.\-com/dyn/resources/prod\-\_\-documents/doc8161.\-pdf} 